#!/bin/bash
#SBATCH --job-name=Fed_val      ## Job 名稱
#SBATCH --mail-type=ALL            ## 收到通知條件
#SBATCH --mail-user=chander92811@gmail.com
#SBATCH --nodes=1                  ## 索取 x 個節點
#SBATCH --cpus-per-task=16         ## 每個 task 索取 x 顆 CPU
#SBATCH --gres=gpu:4           ## 每個節點索取 x 張 GPU
#SBATCH --account="GOV113038"      ## iService_ID 計畫 ID
#SBATCH --partition=gp1d         ## 使用測試 queue
#SBATCH --output=z_fed_val.log  ## 將標準輸出記錄到 log
#SBATCH --error=z_fed_val.log   ## 將錯誤輸出記錄到同一個 log

#export=ALL,WANDB_API_KEY=b0873e135aede1107b9524e83fbd2d526ac60861

# needed in H100
#module purge
#module load singularity

# sif
#SIF=/work/chander92811/yolo9t2_ngc2306_20241226.sif
SIF=/home/chander92811/yolo9t2_ngc2306_20241226.sif
SINGULARITY="singularity run --nv $SIF"

# defind master
MASTER_ADDR=$(scontrol show hostname $SLURM_NODELIST | head -n 1)
export MASTER_ADDR

## twcc 不知為何SLURM_GPUS_ON_NODE 為空
nvidia-smi --list-gpus
NGPU=$(nvidia-smi -L | wc -l) # $SLURM_GPUS_ON_NODE
export NGPU

echo "==============================="

## 呼叫 yolo train torchrun 版本
# srun --gres=gpu:$SLURM_GPUS_ON_NODE --mpi=pmix $SINGULARITY bash yolotrain_segment.sh # SLURM_GPUS_ON_NODE 只有H100上才有

cmd="srun --gres=gpu:$NGPU --mpi=pmix $SINGULARITY bash fed_val.sh"
echo $cmd
$cmd
